# EML Viewer & Validator

## é–‹ç™ºãƒ«ãƒ¼ãƒ«

- **å¿œç­”ãƒ»PRãƒ»ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯åŸºæœ¬çš„ã«æ—¥æœ¬èªã§è¨˜è¿°ã™ã‚‹**
- ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå‚ç…§ã«ã¯Context7 MCPã‚’ä½¿ç”¨ã™ã‚‹

## ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦

EMLãƒ•ã‚¡ã‚¤ãƒ«ã®é–²è¦§ãƒ»æ¤œè¨¼ãƒ„ãƒ¼ãƒ«ã€‚å˜ãªã‚‹ãƒ“ãƒ¥ãƒ¼ãƒ¯ãƒ¼ã§ã¯ãªãã€ãƒ¡ãƒ¼ãƒ«èªè¨¼ï¼ˆDKIM/SPF/DMARCï¼‰ã®æ¤œè¨¼ã€é€ä¿¡å…ƒã®ä¿¡é ¼æ€§ç¢ºèªã€æ”¹ã–ã‚“æ¤œçŸ¥ãªã©ãŒã§ãã‚‹ã€Œãƒ¡ãƒ¼ãƒ«æ¤œè¨¼ãƒ„ãƒ¼ãƒ«ã€ã€‚

## ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼

- æ³•å‹™ãƒ»ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹æ‹…å½“ï¼ˆè¨¼æ‹ ä¿å…¨ã€ç›£æŸ»å¯¾å¿œï¼‰
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ‹…å½“ï¼ˆãƒ•ã‚£ãƒƒã‚·ãƒ³ã‚°åˆ¤å®šã€èªè¨¼æ¤œè¨¼ï¼‰
- ITç®¡ç†è€…ï¼ˆãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒˆã€é…ä¿¡å•é¡Œèª¿æŸ»ï¼‰
- ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆæ€ªã—ã„ãƒ¡ãƒ¼ãƒ«ã®ç¢ºèªï¼‰

## æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰
- **Cloudflare Pages**
- ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯: React or Vanilla JSï¼ˆè»½é‡å„ªå…ˆï¼‰
- UIãƒ©ã‚¤ãƒ–ãƒ©ãƒª: Tailwind CSS
- EMLãƒ‘ãƒ¼ã‚¹: ãƒ–ãƒ©ã‚¦ã‚¶å´ã§JSãƒ‘ãƒ¼ã‚¹

### ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰
- **Cloudflare Workers**
- DNSå•ã„åˆã‚ã›ï¼ˆDoHçµŒç”±ï¼‰
- DKIMç½²åæ¤œè¨¼ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
- ãƒãƒƒã‚·ãƒ¥è¨ˆç®—

### ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ï¼ˆç›£æŸ»å¯¾å¿œç”¨ï¼‰
- **D1**: ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã€ãƒ­ã‚°ã€IPã€@ç§»è¡Œ
- **R2**: EMLãƒ•ã‚¡ã‚¤ãƒ«æœ¬ä½“

## æ©Ÿèƒ½ä¸€è¦§

### Phase 1ï¼ˆMVPï¼‰
- [ ] EMLãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—
- [ ] åŸºæœ¬æƒ…å ±è¡¨ç¤ºï¼ˆFrom, To, Subject, Dateï¼‰
- [ ] æœ¬æ–‡è¡¨ç¤ºï¼ˆHTML/ãƒ†ã‚­ã‚¹ãƒˆåˆ‡ã‚Šæ›¿ãˆï¼‰
- [ ] æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ãƒ»ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
- [ ] Authentication-Resultsãƒ˜ãƒƒãƒ€ãƒ¼ã®å¯è¦–åŒ–
- [ ] ãƒ•ã‚¡ã‚¤ãƒ«ãƒãƒƒã‚·ãƒ¥ï¼ˆSHA-256ï¼‰è¡¨ç¤º

### Phase 2ï¼ˆå·®åˆ¥åŒ–ï¼‰
- [ ] è¤‡æ•°EMLãƒ•ã‚¡ã‚¤ãƒ«å¯¾å¿œ
- [ ] ã‚¹ãƒ¬ãƒƒãƒ‰è¡¨ç¤ºï¼ˆæ™‚ç³»åˆ—ä¸¦ã¹ï¼‰
- [ ] DNSå•ã„åˆã‚ã›ï¼ˆSPF/DKIM/DMARCãƒ¬ã‚³ãƒ¼ãƒ‰å–å¾—ï¼‰
- [ ] é€ä¿¡å…ƒãƒ‰ãƒ¡ã‚¤ãƒ³ã®æƒ…å ±è¡¨ç¤º
- [ ] Receivedãƒ˜ãƒƒãƒ€ãƒ¼ã®çµŒè·¯å¯è¦–åŒ–

### Phase 3ï¼ˆä¸Šç´šè€…å‘ã‘ï¼‰
- [ ] DKIMç½²åã®å†æ¤œè¨¼
- [ ] é€ä¿¡å…ƒIPã®Geolocation
- [ ] ãƒ¬ãƒãƒ¼ãƒˆå‡ºåŠ›ï¼ˆPDFï¼‰
- [ ] æ¯”è¼ƒæ©Ÿèƒ½ï¼ˆ2ã¤ã®EMLã‚’ä¸¦ã¹ã¦å·®åˆ†ç¢ºèªï¼‰

## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Cloudflare     â”‚      â”‚  Cloudflare     â”‚
â”‚  Pages          â”‚â”€â”€â”€â”€â”€â–¶â”‚  Workers        â”‚
â”‚  (ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰)â”‚      â”‚  (API)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚             â”‚             â”‚
                    â–¼             â–¼             â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚   D1    â”‚   â”‚   R2    â”‚   â”‚  DoH    â”‚
              â”‚ (ãƒ¡ã‚¿)  â”‚   â”‚ (ãƒ•ã‚¡ã‚¤ãƒ«)â”‚   â”‚ (DNS)   â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## APIè¨­è¨ˆ

### Worker Endpoints

```
POST /api/verify
  - EMLã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’å—ã‘å–ã‚Šã€DNSæ¤œè¨¼ã‚’å®Ÿè¡Œ
  - Request: { domain, dkimSelector, senderIP }
  - Response: { spf, dkim, dmarc, geoIP }

POST /api/store (ç›£æŸ»ç”¨)
  - EMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’æš—å·åŒ–ã—ã¦R2ã«ä¿å­˜
  - Request: { emlBase64, metadata }
  - Response: { id, hash, storedAt }

GET /api/dns/:type/:domain
  - DNSãƒ¬ã‚³ãƒ¼ãƒ‰å–å¾—
  - Example: /api/dns/txt/_dmarc.example.com
```

## DNSå•ã„åˆã‚ã›ï¼ˆDoHï¼‰

```javascript
// Cloudflare DoH ã‚’ä½¿ç”¨
async function getDNSRecord(name, type = 'TXT') {
  const response = await fetch(
    `https://cloudflare-dns.com/dns-query?name=${encodeURIComponent(name)}&type=${type}`,
    { headers: { 'Accept': 'application/dns-json' } }
  );
  return response.json();
}

// SPFå–å¾—
const spf = await getDNSRecord('example.com', 'TXT');

// DKIMå–å¾—
const dkim = await getDNSRecord('selector._domainkey.example.com', 'TXT');

// DMARCå–å¾—
const dmarc = await getDNSRecord('_dmarc.example.com', 'TXT');
```

## EMLãƒ‘ãƒ¼ã‚¹ï¼ˆãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼‰

```javascript
// postal-mimeãƒ©ã‚¤ãƒ–ãƒ©ãƒªæ¨å¥¨
import PostalMime from 'postal-mime';

async function parseEML(emlContent) {
  const parser = new PostalMime();
  const email = await parser.parse(emlContent);

  return {
    from: email.from,
    to: email.to,
    subject: email.subject,
    date: email.date,
    html: email.html,
    text: email.text,
    attachments: email.attachments,
    headers: email.headers
  };
}
```

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ»ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼æ–¹é‡

### é‡è¦: ãƒ‡ãƒ¼ã‚¿å–ã‚Šæ‰±ã„ã«ã¤ã„ã¦

ã“ã®ãƒ„ãƒ¼ãƒ«ã¯**ç›£æŸ»å¯¾å¿œ**ã‚’ç›®çš„ã¨ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’ä¿ç®¡ã™ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ãŒã€ä»¥ä¸‹ã®æ–¹é‡ã‚’éµå®ˆã—ã¾ã™ï¼š

1. **ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®éåé›†**
   - å€‹äººã‚’ç‰¹å®šã™ã‚‹æƒ…å ±ã¯åé›†ã—ã¾ã›ã‚“
   - ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ã¯åŒ¿ååŒ–ã•ã‚Œã¾ã™
   - ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ãƒ»åºƒå‘Šã¯ä¸€åˆ‡ä½¿ç”¨ã—ã¾ã›ã‚“

### UIä¸Šã§ã®è¡¨ç¤ºä¾‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”’ ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ã«ã¤ã„ã¦                                  â”‚
â”‚                                                         â”‚
â”‚ â€¢ ãƒ•ã‚¡ã‚¤ãƒ«ã¯æš—å·åŒ–ã—ã¦ä¸€æ™‚ä¿ç®¡ã•ã‚Œã¾ã™ï¼ˆç›£æŸ»å¯¾å¿œç”¨ï¼‰      â”‚
â”‚ â€¢ å€‹äººæƒ…å ±ã¯åé›†ã—ã¦ã„ã¾ã›ã‚“                            â”‚
â”‚ â€¢ 90æ—¥å¾Œã«è‡ªå‹•å‰Šé™¤ã•ã‚Œã¾ã™                              â”‚
â”‚ â€¢ è©³ç´°ã¯ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ã‚’ã”ç¢ºèªãã ã•ã„            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## UIè¨­è¨ˆæ–¹é‡

- **Squooshé¢¨ã®ãƒ¢ãƒ€ãƒ³UI**
- ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œ
- ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ä¸­å¿ƒã®æ“ä½œ
- èªè¨¼çµæœã¯è‰²åˆ†ã‘ã§ç›´æ„Ÿçš„ã«
  - âœ… ç·‘: Pass
  - âš ï¸ é»„: ä¸æ˜/ä¸€éƒ¨å•é¡Œ
  - âŒ èµ¤: Fail

## ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

```
eml-viewer/
â”œâ”€â”€ frontend/              # Cloudflare Pages
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”‚   â”œâ”€â”€ DropZone.jsx
â”‚   â”‚   â”‚   â”œâ”€â”€ EmailViewer.jsx
â”‚   â”‚   â”‚   â”œâ”€â”€ AuthResults.jsx
â”‚   â”‚   â”‚   â”œâ”€â”€ ThreadView.jsx
â”‚   â”‚   â”‚   â””â”€â”€ HashInfo.jsx
â”‚   â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â”‚   â”œâ”€â”€ emlParser.js
â”‚   â”‚   â”‚   â””â”€â”€ hashUtils.js
â”‚   â”‚   â”œâ”€â”€ App.jsx
â”‚   â”‚   â””â”€â”€ index.js
â”‚   â”œâ”€â”€ public/
â”‚   â””â”€â”€ package.json
â”‚
â”œâ”€â”€ worker/                # Cloudflare Workers
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ index.js
â”‚   â”‚   â”œâ”€â”€ dns.js
â”‚   â”‚   â”œâ”€â”€ storage.js
â”‚   â”‚   â””â”€â”€ verify.js
â”‚   â””â”€â”€ wrangler.toml
â”‚
â”œâ”€â”€ shared/                # å…±é€šå‹å®šç¾©ãªã©
â”‚   â””â”€â”€ types.ts
â”‚
â””â”€â”€ claude.md              # ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«
```

## wrangler.tomlï¼ˆWorkerè¨­å®šï¼‰

```toml
name = "eml-viewer-api"
main = "src/index.js"
compatibility_date = "2024-01-01"

[[d1_databases]]
binding = "DB"
database_name = "eml-viewer-db"
database_id = "xxx"

[[r2_buckets]]
binding = "BUCKET"
bucket_name = "eml-storage"
```

## D1ã‚¹ã‚­ãƒ¼ãƒ

```sql
CREATE TABLE IF NOT EXISTS eml_records (
  id TEXT PRIMARY KEY,
  hash_sha256 TEXT NOT NULL,
  from_domain TEXT,
  subject_preview TEXT,
  stored_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  expires_at DATETIME,
  metadata TEXT  -- JSON
);

CREATE INDEX idx_hash ON eml_records(hash_sha256);
CREATE INDEX idx_expires ON eml_records(expires_at);
```

## é–‹ç™ºã‚³ãƒãƒ³ãƒ‰

```bash
# ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰é–‹ç™º
cd frontend
npm install
npm run dev

# Workeré–‹ç™º
cd worker
npm install
npx wrangler dev

# ãƒ‡ãƒ—ãƒ­ã‚¤
npx wrangler pages deploy frontend/dist
npx wrangler deploy
```

## å‚è€ƒãƒ©ã‚¤ãƒ–ãƒ©ãƒª

- **postal-mime**: EMLãƒ‘ãƒ¼ã‚¹ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶å¯¾å¿œï¼‰
- **Web Crypto API**: ãƒãƒƒã‚·ãƒ¥è¨ˆç®—ã€æš—å·åŒ–
- **Cloudflare DoH**: DNSå•ã„åˆã‚ã›

## ä»Šå¾Œã®æ‹¡å¼µæ¡ˆ

- Chromeæ‹¡å¼µç‰ˆ
- Gmailã‹ã‚‰ã®ç›´æ¥ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆé€£æº
- Slacké€šçŸ¥ï¼ˆæ€ªã—ã„ãƒ¡ãƒ¼ãƒ«æ¤œçŸ¥æ™‚ï¼‰
- APIæä¾›ï¼ˆæœ‰æ–™ï¼‰

---

## é–‹ç™ºãƒ¡ãƒ¢

ï¼ˆã“ã“ã«é–‹ç™ºä¸­ã®ãƒ¡ãƒ¢ã‚’è¿½è¨˜ã—ã¦ã„ãï¼‰
